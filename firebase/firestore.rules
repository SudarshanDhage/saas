rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the user is accessing their own data
    function isCurrentUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Default deny all rule
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Root users collection
    match /users/{userId} {
      // Allow users to read and write their own user document
      allow read, write: if isCurrentUser(userId);
      
      // Projects sub-collection
      match /projects/{projectId} {
        allow read, write: if isCurrentUser(userId);
        
        // Project sprints
        match /sprints/{sprintId} {
          allow read, write: if isCurrentUser(userId);
        }
        
        // Project features
        match /features/{featureId} {
          allow read, write: if isCurrentUser(userId);
        }
        
        // Project documentation
        match /documentation/{docId} {
          allow read, write: if isCurrentUser(userId);
        }
      }
      
      // Features sub-collection
      match /features/{featureId} {
        allow read, write: if isCurrentUser(userId);
      }
      
      // Account sub-collection
      match /account/{docId} {
        allow read, write: if isCurrentUser(userId);
      }
    }
    
    // CollectionGroup queries - needed for querying across subcollections
    match /{path=**}/projects/{projectId} {
      allow read: if isAuthenticated() && 
                  get(/databases/$(database)/documents/$(path)).data.userId == request.auth.uid;
    }
    
    match /{path=**}/features/{featureId} {
      allow read: if isAuthenticated() && 
                  get(/databases/$(database)/documents/$(path)).data.userId == request.auth.uid;
    }
    
    match /{path=**}/sprints/{sprintId} {
      allow read: if isAuthenticated() && 
                  get(/databases/$(database)/documents/$(path)).data.userId == request.auth.uid;
    }
  }
} 